---
title: "SpectralAnalysis"
author: "Estelle"
date: "2023-11-22"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Spectral analysis of the rapid Eye data
```{r}
# library(devtools)
# install_github("bleutner/RStoolbox")

library(dplyr)
library(rio)
library(tidyverse)
library(sf)
library(raster)
library(sp)
library(tiff)
library(glcm)
library(rgdal)
library(rgeos)
library(RStoolbox)
library(RColorBrewer)
library(tmap)
```

```{r}
workdir <- getwd()
sa_wd <- paste0(workdir, "/spectral_analysis")
geoproc_wd <- paste0(workdir, "/spectral_analysis/geo_proc")
```


### load rapid eye layer
```{r}
rap <- raster::stack(paste0(sa_wd, "/rapid_eye_berlin_2017_3035.tif"))

glimpse(rap)
raster::res(rap)

```

# 1. Compute ndvi
```{r}
# extract red and near-infrared layer
red <- subset(rap, 3) # B3
nir <- subset(rap, 4) # B4

# calculate ndvi layer
ndvi <- (nir-red) / (nir+red)

# give this layer a name
names(ndvi) <- 'ndvi'

# trim NDVI range to -1 and 1
ndvi[ndvi < -1] <- -1
ndvi[ndvi > 1] <- 1

# plot NDVI raster layer
plot(ndvi)

writeRaster(ndvi, paste0(geoproc_wd, "/rapid_eye_ndvi_3035.tif"), overwrite = T)
# ndvi <- raster(paste0(geoproc_wd, "/rapid_eye_ndvi_3035.tif"))
```


# 2. Read the fraction image 
(berlin_reference_class_fractions.tif). The image contains the following 4 layers/bands: âimpâ, âveglowâ, âveghighâ, âsoilâ. Rename the band names to these names. Create a new (separate) layer âvegcovâ, representing total vegetation cover (veglow and veghigh)

# lcf <- readOGR("C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/Urban_unmixing/tutorial_regression_based_unmixing_materials_2020/tutorial_data/vector/landcover_berlin.shp")
lcf <- stack("C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/Urban_unmixing/berlin_reference_class_fractions.tif")
glimpse(lcf)
plot(lcf)
names(lcf) <- c('imp', 'veglow', 'veghigh', 'soil')

# combine low and high vegetation
img_vegcov <- subset(lcf,2) + subset(lcf, 3)

# reproject
img_vegcov_3035   <- projectRaster(img_vegcov, crs = as.character(crs(ndvi))) # reproject to 3035
i# mg_vegcov_3035_c <- crop(img_vegcov_3035, ndvi)

## resample veg fractions to rapidEye image 
img_vegcov_3035_c_res <- resample(img_vegcov_3035,ndvi,method='bilinear')
writeRaster(img_vegcov_3035_c_res, "C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/7_Spectral_analysis/repro_img_veg_cover_resampled_to_rapid_eye.tif", overwrite = TRUE)
plot(img_vegcov_3035_c_res)

## set values above 1 to 1
img_vegcov_3035_c_res[img_vegcov_3035_c_res>1] <- 1

## stack
lcstack <- stack(ndvi, img_vegcov_3035_c_res)

# add meaningful layer names
names(lcstack) <- c('ndvi', 'vegcov')

# sample
set.seed(260)

## Alternative sampling approach 
## -------------------------------------------------------------------------- ##
## random sampling inside stratas (0-20, 21-40, 41-60, 61-80, 81-100)

## --> create raster layer with strata 1-5 inside known fractions 
#smp_1 <- sampleRandom(img_vegcov_3035_c_res[[img_vegcov_3035_c_res == 0]], 10, na.rm = T)
#img_vegcov_3035_c_res_strat <- img_vegcov_3035_c_res[ifelse(img_vegcov_3035_c_res == 0 && img_vegcov_3035_c_res <= 0.2, 1, 0)]

strata <- c(0,0.2,0.4,0.6,0.8,1)
n_each <- 1000

## loop over all stratum borders defined before 
for (i in seq(1:(length(strata)-1))) { 
  print(i)
  ## copy raster to temp 
  temp_ras <- img_vegcov_3035_c_res
  from <- strata[i]
  to   <- strata[i+1]
  
  ## mask temp raster based on strata
  print(paste0("from: ", from, " to: ", to))
  if(from == 0){
    temp_ras[temp_ras > to] <- NA 
  } else {
    temp_ras[temp_ras < from | temp_ras >= to] <- NA
  }
  
  ## smp in each stratum and combine results 
  if(from == 0){
    smps <- sampleRandom(mask(lcstack,temp_ras), n_each, na.rm = T, sp = TRUE, cells = TRUE)
    print(smps)
  } else {
    smps_t <- sampleRandom(mask(lcstack,temp_ras), n_each, na.rm = T, sp = TRUE, cells = TRUE)
    smps <- union(smps, smps_t)
  }
}

## write load samples 
writeOGR(smps, "S:/Bird/smps/samples_ndvi_fractions.shp",1, driver = "ESRI Shapefile")
smps <- readOGR("S:/Bird/smps/samples_ndvi_fractions.shp")

## plot ndvi vs frac cover 
ggplot(smps@data, aes (x= vegcov, y= ndvi)) + geom_point()

# to data.frame
df_sample <- as.data.frame(smps@data)
df_sample[df_sample$vegcov < 0] <- 0

## 75% of the sample size
smp_size <- floor(0.7 * nrow(df_sample))

## set the seed to make your partition reproducible
set.seed(123)
train_ind <- sample(seq_len(nrow(df_sample)), size = smp_size)

train <- df_sample[train_ind, ]
test  <- df_sample[-train_ind, ]

#-----
# save training and test data set
write.csv(lc.train, 'C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/Urban_unmixing/Fraction map/train/vegcov_ndvi_train.csv', row.names=F)
write.csv(lc.test, 'C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/Urban_unmixing/Fraction map/train/vegcov_ndvi_test.csv', row.names=F)


#Develop a simple linear model between vegcov and NDVI using the training sample
veglm1 <- lm(vegcov ~ ndvi, data=train)

# the intercept is
coefficients(veglm1)[1]

## the slope is
coefficients(veglm1)[2]

#the R2 is
summary(veglm1)$r.squared

#Create a scatterplot of vegcov versus NDVI. Add the regression line.
VegcovNDVI <- function(){
  plot(train$vegcov, train$ndvi, xlab = "Vegetation Cover", ylab = "NDVI", pch = 16, cex = 0.5, col = "#d7191c", main = "Vegetation Cover v. NDVI (Original Model)",  abline(veglm1, col = "#404040", lwd = 1.5))
}
VegcovNDVI()

summary(veglm1)

predicted <- predict(veglm1, test)
observed <- test$vegcov
plot(predicted ~ observed)

# MAE (Mean absolute error)
mean(abs(predicted-observed))

# RMSE
sqrt(mean((predicted-observed)^2, na.rm=T))

# variable names used in the model formula
formula(veglm1)
#layer names in raster
# rename layer to 'ndvi_mean'
names(ndvi) <- 'ndvi' 
names(ndvi)

# apply predict function to ndvi layer
img_predvegcov <- predict(ndvi, veglm1)

plot(img_predvegcov)

# writeRaster(img_predvegcov, filename="C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/Urban_unmixing/Fraction map/rapideye_berlin_clip_vegcov.tif", format='GTiff', overwrite=TRUE)
writeRaster(img_predvegcov, filename="S:/Bird/fraction/estelle_method/predicted_veg_fraction_estelle_all_berlin.tif", format='GTiff', overwrite=TRUE)
img_predvegcov <- raster("C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/7_Spectral_analysis/predicted_veg_fraction_estelle_all_berlin.tif")

# set ndvi ## i think thilos mask was 75 percent
img_predvegcov_75 <- img_predvegcov
img_predvegcov_75[img_predvegcov_75<0.75] <- NA
plot(img_predvegcov_75,
     main="vegetation cover > .75 ")

## set to range 0 1 
img_predvegcov_75[img_predvegcov_75 < 0] <- 0
img_predvegcov_75[img_predvegcov_75 > 1] <- 1

# writeRaster(img_predvegcov_75, filename="C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/Urban_unmixing/Fraction map/rapideye_berlin_clip_vegcov_0.7.tif", format='GTiff', overwrite=TRUE)
writeRaster(img_predvegcov_75, filename="C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/predicted_veg_fraction_estelle_75_percent_mask_0_1.tif", format='GTiff', overwrite=TRUE)
img_predvegcov_75 <- raster("C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/predicted_veg_fraction_estelle_75_percent_mask_0_1.tif")
img_predvegcov_75_stack <- stack("C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/7_Spectral_analysis/rapideye_berlin_clip_vegcov_0.7.tif")
img_predvegcov_75_brick <- brick("C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/7_Spectral_analysis/rapideye_berlin_clip_vegcov_0.7.tif")
## ------------------------------------------------------------------------- ##
plot(img_predvegcov_75)

# 3. Prepare new layers based on the reference values

(if you would want to precisely follow thilo's method; you would have to mask also agcricultural areas here )

## mask agriculture 
biotope<- readOGR("C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/7_Spectral_analysis/wfs_Berlin_Landuse_2.shp")

plot(biotope)
Landwirt <-biotope[biotope$TYPKLAR == "Landwirtschaft",]
plot(Landwirt)

masked_predvegcov<-mask(x =img_predvegcov_75, mask =Landwirt, inverse = T)
plot(masked_predvegcov)
writeRaster(masked_predvegcov, "C:/Users/User/Documents/IZW/Estelle_UrbanFunctionalDiversity/4_data_processed/masked_predvegcov.tif", overwrite=TRUE)

```{r load masked data}
masked_predvegcov <- raster(paste0(sa_wd, "/masked_predvegcov.tif"))

```

```{r}
## first we stack the rapid eye scene with the ndvi layer 
rap_ndvi <- stack(rap, ndvi)

## now we use the cut of vegetation fractions to mask the original Rapid Eye Scene
rap_masked <- mask(rap_ndvi, masked_predvegcov)
# writeRaster(rap_masked, paste0(sa_wd, "/rapid_eye_berlin_2017_3035_masked.tif"), overwrite=TRUE)
# rap_masked <- stack(paste0(sa_wd, "/rapid_eye_berlin_2017_3035_masked.tif"))
```


--> now we have the rapid eye scene reduced to the pixel that have more that 75 percent vegetation fraction 

# 4. we calculate the pca from the left pixels (only the five original bands) 
```{r}
pca <- rasterPCA(subset(rap_masked,1:5))
summary(pca$model)
plot(pca$map)
loadings(pca$model)

```


## then we stack the first two bands of the pca with the ndvi layer and use it further..  
```{r}
pca_map <- pca$map
pc1 <- pca_map$PC1
# writeRaster(pc1, paste0(geoproc_wd, "/RE_pca_band1.tif"), overwrite = T)

pc2 <- pca_map$PC2
pc1_pc2 <- stack(pc1, pc2)
names(pc1_pc2)

# writeRaster(pc2, paste0(geoproc_wd, "/RE_pca_band2.tif"), overwrite = T)
writeRaster(pc1_pc2, paste0(geoproc_wd, "/RE_pca_band1_and_2.tif"), overwrite = T)

plot(pc1)
```



# 5. compute ndvi on rap_masked

extract red and near-infrared layer
```{r}
red <- subset(rap_masked, 3) # B3
nir <- subset(rap_masked, 4) # B4
```

calculate ndvi layer
```{r}
ndvi_masked <- (nir-red) / (nir+red)

# give this layer a name
names(ndvi_masked) <- 'ndvi'

# trim NDVI range to -1 and 1
ndvi_masked[ndvi_masked < -1] <- -1
ndvi_masked[ndvi_masked > 1] <- 1
```

## plot NDVI raster layer
```{r}
plot(ndvi_masked)
# writeRaster(ndvi_masked, paste0(geoproc_wd, "/RE_ndvi_masked.tif"))

pca_ndvi <- stack(pc1, pc2, ndvi_masked)

writeRaster(pca_ndvi, paste0(geoproc_wd, "/RE_pca_band1_band2_ndvi.tif"))
```

# 6. GLCMs 
```{r}
glcm_ndvi <- glcm(ndvi_masked, window = c(5,5))
plot(glcm_ndvi$glcm_homogeneity)
glcm_homogeneity <- glcm_ndvi$glcm_homogeneity
writeRaster(glcm_homogeneity, paste0(geoproc_wd, "/RE_glcm_homogeneity.tif"))

pca_ndvi_glcm <- stack(pca_ndvi, glcm_ndvi)

pca_ndvi_glcm$PC1
plot(pca_ndvi_glcm$glcm_homogeneity)

writeRaster(pca_ndvi_glcm, paste0(geoproc_wd, "/RE_pca_ndvi_glcm.tif"), overwrite = TRUE)

my_rastnames <- as.data.frame(names(pca_ndvi_glcm))
colnames(my_rastnames) <- "names"
write.csv(my_rastnames, paste0(geoproc_wd, "/RE_pca_ndvi_glcm_names.csv"), row.names = FALSE)
```

#compute Geary and Moran
#rap_masked_moran<-Moran(rap_masked)

#masked_predvegcov_geary<- Geary(masked_predvegcov)
#install.packages("installr"); library(installr) # install+load installr
#updateR() # updating R.